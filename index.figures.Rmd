---
title: "index.figures"
author: "Simon Topp"
date: "7/6/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RColorBrewer)
library(scales)
library(tidyverse)
library(gridExtra)
library(grid)
library(lattice)
library(cowplot)
library(ggpubr)
```

# Make some Figures!


```{r}
munge <- index.munge %>% filter(!is.na(Parameter.Grp))

#### Create Filtered List with  entry per paper for certain figures
####Figs

#Parameter Distribution
#Reorder Models
munge$Model <- factor(munge$Model, levels = c('Empirical', 'Semi.Empirical', 'Semi.Analytical', 'Machine.Learning', 'Mixed', 'Product'))


munge$Parameter <- factor(munge$Parameter, levels = c('Chl', 'TSS', 'Clarity', 'DOC', 'Nutrients', 'Turbidity', 'Carbon.Other', 'Cyanobacteria', 'Sediments.Other', 'Metals', 'Chromaticity', 'Trophic', 'Other'), labels = c('Chl', 'TSS', 'Clarity', 'CDOM', 'Nutrients', 'Turbidity', 'Other Carbon', 'Cyanobacteria', 'Other Sediments', 'Metals', 'Chromaticity', 'Trophic State', 'Other'))

munge$Parameter.Grp <- factor(munge$Parameter.Grp, 
                              levels = c("Algae","Carbon", "Clarity", "Suspended.Sediment","Turbidity", "Nutrients", "Other"))

munge$Coverage.KM <- factor(munge$Coverage.KM, levels = c('1','2','3','4','5','6'), labels = c('10^1','10^2', '10^3', '10^4', '10^5', '10^6'))

munge$Cat <- factor(munge$Cat, levels = c('Methods', 'Trends', 'Causal'))


#Create Filtered Set With only 1 entry per paper.
filt <- munge %>%
  select(-c(Parameter, Landscape.var, Num.Models, Best.AC,Error.fit1, Error.fit2,Error.fit3,Error.val1,Error.val2,Error.val3,Fit.metric1, Fit.metric2,Fit.metric3,Val.metric1,Val.metric2,Val.metric3, Atm.Comp, Sensor, Sensor.Type)) %>%
  distinct(ID, .keep_all = T) %>%
  filter(!is.na(Figs.m),
         !is.na(Model),
         !is.na(Coverage.KM))

```

#Figs


```{r}
### Year Model Density

viz <- function(data, x, fill, stack, label){
        if(stack == 'stack'){
        plot <-ggplot(data, aes(x = x, y = stat(count), fill = fill)) +
                geom_density(position = 'stack', alpha = 0.6) + 
                scale_fill_brewer(palette = 'Paired') +
                scale_x_continuous(breaks = pretty_breaks(n=10)) +
                theme_bw() + 
                labs(x = 'Years', y = 'Count', fill = label) + 
                theme(axis.text.x = element_text(angle = 90, hjust = 1),
                legend.text=element_text(size=7),
                axis.title = element_blank(),
                legend.position = 'top',
                legend.title=element_text(size=9),
                legend.key.size = unit(0.5,'cm')) +
                guides(fill = guide_legend(nrow = 2, title.position = 'top'))
        } 
        if(stack == 'fill'){
        plot <- ggplot(data, aes(x = x, fill = fill)) + 
        geom_density(position = 'fill', alpha = 0.6) + 
        scale_y_continuous(labels = percent) +
        scale_x_continuous(breaks = pretty_breaks(n=10)) +
        scale_fill_brewer(palette = 'Paired') +
        theme_bw() + 
        labs(x = 'Year', y = 'Distribution', fill = label) + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.text=element_text(size=7),
              axis.title = element_blank(),
              legend.position = 'top',
              legend.title=element_text(size=9),
              legend.key.size = unit(0.5,'cm')) +
        guides(fill = guide_legend(nrow = 2, title.position = 'top'))
        }
  return(plot)
  }


####Yearly Distributions


#########Fill Figure
##Year Params Groups
p1 <- viz(munge, munge$Year, munge$Parameter.Grp, 'fill', 'Modelled Parameters') + scale_fill_brewer(breaks = c('Clarity', 'Suspended.Sediment', 'Carbon', 'Algae','Turbidity', 'Nutrients', 'Other'), labels = c('Clarity', 'Suspended\nSediment', 'Carbon', 'Algae','Turbidity', 'Nutrients', 'Other'), palette = 'Paired')

##Year Modelling Approach Groups
p2 <- viz(filt, filt$Year, filt$Model, 'fill', 'Modelling Approach')

## Year Coverage Fill
p3 <- viz(filt, filt$Year, filt$Coverage.KM, 'fill', expression(paste('Coverage Scale (km'^'2',')')))

## Year Years Fill
p4 <- viz(filt, filt$Year, filt$Time.Bin, 'fill', 'Study Duration')

g <- grid.arrange(
  grobs = list(p1,p2,p3,p4),
  layout_matrix = rbind(c(1, 2),
                        c(3, 4)),
  left = 'Distribution',
  bottom = 'Year'
)

ggsave(filename='figures/YearDistv2.png',plot = g, width=6.5,height=6, units='in', dpi=250)

#############Stack Figure
##Year Params Groups
p1 <- viz(munge, munge$Year, munge$Parameter.Grp, 'stack', 'Modelled Parameters')

##Year Modelling Approach Groups
p2 <- viz(filt, filt$Year, filt$Model, 'stack', 'Modelling Approach')

## Year Coverage Fill
p3 <- viz(filt, filt$Year, filt$Coverage.KM, 'stack', expression(paste('Coverage Scale (km'^'2*)')))

## Year Years Fill
p4 <- viz(filt, filt$Year, filt$Time.Bin, 'stack', 'Study Duration')

g <- grid.arrange(
  grobs = list(p1,p3,p2,p4),
  layout_matrix = rbind(c(1, 2),
                        c(3, 4)),
  left = 'Distribution',
  bottom = 'Year'
)
ggsave(filename='figures/YearDistStack.png',plot = g, width=6.5,height=6, units='in', dpi=250)



##### Extraneous single panel

##Timescale and Scale?
viz(filt, filt$Years, filt$Coverage.KM, 'fill', 'Study\nDuration')

viz(filt, filt$Year, filt$Cat, 'fill', 'Study Category')

viz(filt, as.numeric(filt$Coverage.KM), filt$Parameter.Grp, 'fill', 'Study Category')

viz(filt, filt$Year, filt$Cat, 'fill', 'Study Category')

ggplot(filt, aes(x = Cat, y = as.numeric(Coverage.KM), colour = Parameter.Grp)) + geom_boxplot()


###Stacked Bar
p1 <- ggplot(munge, aes(x= Parameter, y= ..count.., fill = Model)) + 
  geom_bar()+
  scale_fill_brewer(palette = "Paired") +
  labs(x = 'Parameter', fill = 'Modelling\nApproach') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.text=element_text(size=6),
              legend.title=element_text(size=8),
              legend.key.size = unit(0.5,'cm'),
              axis.title.y = element_blank(),
              axis.text=element_text(size=6),
               axis.title=element_text(size=8)
        )
        
p2 <- ggplot(filt, aes(x = Year.Bin, y = ..count.., fill = Model)) + 
  geom_bar() +
  scale_fill_brewer(palette = "Paired") +
  labs(x = 'Time Period', y = 'Publication Count') +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = 'none',
        axis.text=element_text(size=6),
        axis.title=element_text(size=8),
        axis.title.x = element_text(margin = margin(t = 18)))
              

g <- grid.arrange(p2, p1, ncol = 2, widths = c(1.5,2))
ggsave(filename='figures/YearParam2Panel.png',plot = g, width=6,height=2.8, units='in', dpi=250)

ggsave()
ggplot(munge %>% distinct(Paper.ID, keep_all = T), aes(x = Year.Bin, fill = Catv2)) + geom_bar() + labs(fill = 'Category')
```

## Correlation Analysis
```{r}
library(GGally)

df.cor <- filt %>% 
  dplyr::select(Coverage.KM, Years, Parameter.Grp, Cat) %>%
  mutate(Coverage.KM = as.numeric(Coverage.KM))

ggpairs(df.cor, package = 'reshape')

```


##Scopus Scrape
```{r}
##This workflow works with the scraper code, but it's nice to have keywords, so all the analysis is done with scopus results from their actual GUI.

myQuery <- 'KEY("remote sensing" AND "water quality" AND "River" OR "lake" OR "reservoir")'

theXML <- searchByString(string = myQuery, content = 'standard', outfile = "scopusLakes.xml")

theData <- extractXML(theXML)

write.csv(theData, file = "scrapeRLakes.csv")

scrape <- read.csv('ScopusScape/scopusLakes.csv') %>%
  bind_rows(read.csv('ScopusScape/scopusLakes.csv')) %>%
  bind_rows(read.csv('ScopusScape/scopusRivers.csv')) %>%
  bind_rows(read.csv('ScopusScape/scopusInlandWaters.csv')) %>%
  bind_rows(read.csv('ScopusScape/scopusDeltaEstuary.csv'))

scrape <- scrape %>%
  mutate(Lakes = ifelse(grepl(pattern = c('lake|reservoir'), Author.Keywords,
                                     ignore.case = T),1, 0),
          Rivers = ifelse(grepl(pattern = c('river'), Author.Keywords,
                               ignore.case = T), 1, 0),
          Deltas = ifelse(grepl(pattern = c('delta'), Author.Keywords,
                               ignore.case = T), 1, 0),
          Estuaries = ifelse(grepl(pattern = c('estuary|estuaries'), Author.Keywords,
                               ignore.case = T), 1, 0))
  scrape.sum <- scrape %>%
    summarize(Lakes = sum(Lakes),
              Rivers = sum(Rivers),
              Estuaries = sum(Estuaries),
              Deltas = sum(Deltas))
        
  
  
  mutate(Keywords = ifelse(grepl(pattern = c('lake|reservoir'), Author.Keywords, ignore.case = T) == T & Keywords != 'Lakes and Rivers', 'Lakes', 'Other')) %>%
  mutate(Keywords = ifelse(grepl(pattern = 'river', Author.Keywords, ignore.case = T) & !(grepl(pattern = 'lake', Keywords, ignore.case = T)), 'Rivers', 'Other')) %>%
  mutate(Keywords = ifelse(grepl(pattern = 'delta', Author.Keywords, ignore.case = T) & !(grepl(pattern = c('lake|river'), Keywords, ignore.case = T)), 'Delta', 'Other')) %>%
  mutate(Keywords = ifelse(grepl(pattern = 'estuary|estuaries', Author.Keywords, ignore.case = T) & !(grepl(pattern = c('lake|river|delta'), Keywords, ignore.case = T)), 'Estuary', 'Other')) 
           

scrape <- read.csv('scopusLakes.csv') %>%
  bind_rows(read.csv('scopusRivers.csv'))%>%
  bind_rows(read.csv('scopusInlandWaters.csv'))%>%
  Distinct()

ggplot(scrape, aes(x = Year)) + geom_bar() + labs(title = 'Historic Publications Count')

```

## Word Cloud Experiment
```{r}
# Load
library("tm")
library("SnowballC")
library("wordcloud")
library("RColorBrewer")

keywords <- write(scrape$Author.Keywords, 'ScopusScape/scrape.txt')
keys <- readLines('ScopusScape/scrape.txt')
docs <- Corpus(VectorSource(keys))
inspect(docs)

# Convert the text to lower case
docs <- tm_map(docs, content_transformer(tolower))
# Remove numbers
docs <- tm_map(docs, removeNumbers)
# Remove english common stopwords
docs <- tm_map(docs, removeWords, stopwords("english"))
# Remove your own stop word
# specify your stopwords as a character vector
# Remove punctuations
docs <- tm_map(docs, removePunctuation)
# Eliminate extra white spaces
docs <- tm_map(docs, stripWhitespace)
# Text stemming
# docs <- tm_map(docs, stemDocument)
inspect(docs)

dtm <- TermDocumentMatrix(docs)
m <- as.matrix(dtm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)
head(d, 10)
d <- d %>% filter(freq < 1000)
set.seed(1234)
wordcloud(words = d$word, freq = d$freq, min.freq = 5,
          max.words=200, random.order=T, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
?wordcloud

```




## Temp

```{r}
p5 <- ggplot(munge %>%filter(!is.na(Parameter)&!is.na(Model)),
       aes(Parameter, fill = Model)) + 
        geom_bar() +
        scale_fill_brewer(palette = 'Paired') +
        theme_bw() + 
        labs(x = 'Parameter', y = 'Count', 
             fill = 'Modelling\nApproach') + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.text=element_text(size=7))

ggsave(filename='figures/ParamModelFill1.png',width=4,height=3,units='in',dpi=250)




ggplot(munge%>% filter(!is.na(Parameter)), aes(x = Year.Bin, fill = Parameter.Grp)) + 
  geom_bar() + 
        scale_fill_brewer(palette = 'Paired') +
  theme_bw() + 
  labs(x = 'Years', y = 'Count') + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.text = element_text(size=7))
ggsave(filename='figures/timeParamFill1.png',width=4,height=3,units='in',dpi=250)



ggplot(munge%>% filter(!is.na(Parameter)), aes(x = Year, fill = Parameter.Grp)) + 
        geom_density(position = 'fill', alpha = 0.5) + 
        scale_y_continuous(labels = percent) +
        scale_x_continuous(breaks = pretty_breaks(n=10)) +
        scale_fill_brewer(palette = 'Paired') +
        theme_bw() + 
        labs(x = 'Years', y = 'Count') + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.text=element_text(size=7))
ggsave(filename='figures/timeParamFill2.png',width=4,height=3,units='in',dpi=250)




ggplot(munge%>% filter(!is.na(Parameter)), aes(x = Year, stat(count), fill = Parameter.Grp)) + 
        geom_density(position = 'stack', alpha = 0.5) + 
        scale_fill_brewer(palette = 'Paired') +
        theme_bw() + 
        labs(x = 'Years', y = 'Count') + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1),
              legend.text=element_text(size=7))



```

# Spatial Figures

```{r}
library(ggmap)
library(maptools)
library(maps)
library(sf)
library(rgdal)
library(magrittr)
library(viridis)

check <- filt.sf <- filt %>% 
  filter(Lat != 'Various') %>% 
  mutate(Lat = as.numeric(levels(Lat))[Lat],
         Long = as.numeric(levels(Long))[Long])

filt.sf <- filt %>% 
  filter(Lat != 'Various') %>% 
  mutate(Lat = as.numeric(levels(Lat))[Lat],
         Long = as.numeric(levels(Long))[Long]) %>%
  na.omit() %>%
  st_as_sf(.,coords=c('Long','Lat'),crs=4326) %>%
  st_transform(.,54030)

data("wrld_simpl")
world = st_as_sf(wrld_simpl) %>%
    st_transform(.,54030) %>%
    st_buffer(.,0) 


## Category Spatial
ggplot() + geom_sf(data = world, aes(), fill = 'gray70', color = 'gray90') + 
  geom_sf(data = filt.sf, aes(colour = Catv2), alpha =0.8) + 
  coord_sf(ylim = c(-6000000, 8338578)) +
  theme_bw() +
  scale_colour_viridis_d(name = 'Paper \n Category') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        legend.position = c(0.2,0.22),
        legend.background = element_rect(fill = 'white', colour = 'gray50'))


# Pub Data Spatial
png(filename='figures/PubYearSpatial1.png',width=8,height=6,units='in',res=250)
ggplot() + geom_sf(data = world, aes(), fill = 'gray70', color = 'gray90') + 
  geom_sf(data = filt.sf, aes(colour = Year), alpha =0.9) + 
  coord_sf(ylim = c(-6000000, 8338578)) +
  theme_bw() +
  scale_colour_viridis(name = 'Publication Year') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.grid.major = element_line(color = 'grey70'),
        legend.position = c(0.2,0.22),
        legend.background = element_rect(fill = 'white', colour = 'gray50'))
dev.off()


# Timespan Spatial
png(filename='figures/TimeSpatial1.png',width=8,height=6,units='in',res=250)
ggplot() + geom_sf(data = world, aes(), fill = 'gray70', color = 'gray90') + 
  geom_sf(data = filt.sf, aes(colour = Time.Bin), alpha =0.9) + 
  coord_sf(ylim = c(-6000000, 8338578)) +
  theme_bw() +
  scale_colour_viridis_d(name = 'Time Span') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.grid.major = element_line(color = 'grey70'),
        legend.position = c(0.2,0.22),
        legend.background = element_rect(fill = 'white', colour = 'gray50'))
dev.off()

#Mag Spatial
png(filename='figures/MagSpatial1.png',width=8,height=6,units='in',res=250)
ggplot() + geom_sf(data = world, aes(), fill = 'gray70', color = 'gray90') + 
  geom_sf(data = filt.sf %>% filter(Coverage.KM != 'unknown'), aes(colour = Coverage.KM), alpha =0.9) +
  coord_sf(ylim = c(-6000000, 8338578)) +
  theme_bw() +
  scale_colour_viridis_d(name = 'Coverage (Order\nof Magnitude)') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.grid.major = element_line(color = 'grey70'),
        legend.position = c(0.2,0.22),
        legend.background = element_rect(fill = 'white', colour = 'gray50'))
dev.off()



## Figs Distribution Plot

df <- filt %>%
  mutate(fig.total = Figs.m + Figs.v + Figs.t) %>%
  gather(c(Figs.m:Figs.t), key = 'fig.type', value = 'fig.count') %>%
  na.omit() %>%
  mutate(fig.type = factor(fig.type, levels = c('Figs.m', 'Figs.v', 'Figs.t'), labels = c('Background', 'Validation', 'Applied')),
         Catv2 = factor(Catv2, levels = c('Methods', 'Trends', 'Causal'), labels = c('Methods', 'Trends', 'Causal')))


ggplot(df, aes(x = Catv2, y = fig.count/fig.total)) + geom_violin(aes(colour = fig.type)) + theme_bw() + labs(x = 'Paper Category', y = 'Figure Proportion')

ggplot(df, aes(x = Catv2, y = fig.count/fig.total)) + geom_boxplot(aes(colour = fig.type)) + labs(x = 'Paper Category', y = 'Figure Proportion', colour = 'Figure Type')

ggplot(df, aes(x = Catv2, y = fig.count/fig.total)) + geom_col(aes(colour = fig.type)) + theme_bw()


```

```{r}
dsamp <- diamonds[sample(nrow(diamonds), 1000), ] 

p1 <- qplot(carat, price, data=dsamp, colour=clarity)
p2 <- qplot(carat, price, data=dsamp, colour=clarity, geom="path")

leg <- ggplotGrob(p1)

legend=gTree(children=gList(leg), cl="legendGrob")
widthDetails.legendGrob <- function(x) unit(2, "cm")

grid.arrange(grobs = list(p1 + theme(legend.position="none"),
p2 + theme(legend.position="none")),
legend=legend,
main ="this is a title",
left = "This is my global Y-axis title")


```

